<!DOCTYPE html>
<html lang="en"><head><title>Pipelining</title><meta charset="utf-8"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com"/><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Fira Code&amp;family=Schibsted Grotesk:wght@400;700&amp;family=Source Sans Pro:ital,wght@0,400;0,600;1,400;1,600&amp;display=swap"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta property="og:title" content="Pipelining"/><meta property="og:description" content="Relevant Classes: EECS 370 When considering a Single-Cycle ProcessorMulti-Cycle Processor]] has a higher CPI, but a lower clock period. With Pipelining, we hope to take the best of both worlds: approach a CPI of 1 while being able to keep a lower clock period."/><meta property="og:image" content="https://quartz.jzhao.xyz/static/og-image.png"/><meta property="og:width" content="1200"/><meta property="og:height" content="675"/><link rel="icon" href="./static/icon.png"/><meta name="description" content="Relevant Classes: EECS 370 When considering a Single-Cycle ProcessorMulti-Cycle Processor]] has a higher CPI, but a lower clock period. With Pipelining, we hope to take the best of both worlds: approach a CPI of 1 while being able to keep a lower clock period."/><meta name="generator" content="Quartz"/><link href="./index.css" rel="stylesheet" type="text/css" spa-preserve/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" rel="stylesheet" type="text/css" spa-preserve/><script src="./prescript.js" type="application/javascript" spa-preserve></script><script type="application/javascript" spa-preserve>const fetchData = fetch("./static/contentIndex.json").then(data => data.json())</script></head><body data-slug="Pipelining"><div id="quartz-root" class="page"><div id="quartz-body"><div class="left sidebar"><h1 class="page-title"><a href=".">UMich Course Notes</a></h1><div class="spacer mobile-only"></div><div class="search"><div id="search-icon"><p>Search</p><div></div><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search</title><desc id="desc">Search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"></path><circle cx="8" cy="8" r="7"></circle></g></svg></div><div id="search-container"><div id="search-space"><input autocomplete="off" id="search-bar" name="search" type="text" aria-label="Search for something" placeholder="Search for something"/><div id="search-layout" data-preview="true"></div></div></div></div><div class="darkmode"><input class="toggle" id="darkmode-toggle" type="checkbox" tabindex="-1"/><label id="toggle-label-light" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="dayIcon" x="0px" y="0px" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35" xml:space="preserve"><title>Dark mode</title><path d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5    S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5    C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6    C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9    c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44    l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5    c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06    L6.439,8.561z M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z     M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2    C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29    c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7    C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5    c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"></path></svg></label><label id="toggle-label-dark" for="darkmode-toggle" tabindex="-1"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="nightIcon" x="0px" y="0px" viewBox="0 0 100 100" style="enable-background:new 0 0 100 100" xml:space="preserve"><title>Light mode</title><path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571  C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23  c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369  c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65  c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"></path></svg></label></div><div class="explorer desktop-only"><button type="button" id="explorer" data-behavior="collapse" data-collapsed="collapsed" data-savestate="true" data-tree="[{&quot;path&quot;:&quot;cheatsheets&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;classes&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;exams&quot;,&quot;collapsed&quot;:true},{&quot;path&quot;:&quot;ia-applications&quot;,&quot;collapsed&quot;:true}]"><h1>Explorer</h1><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="explorer-content"><ul class="overflow" id="explorer-ul"><li><div class="folder-outer open"><ul style="padding-left:0;" class="content" data-folderul><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="cheatsheets"><button class="folder-button"><span class="folder-title">cheatsheets</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="cheatsheets"><li><a href="./cheatsheets/EECS-281-Midterm-Cheat-Sheet" data-for="cheatsheets/EECS-281-Midterm-Cheat-Sheet">EECS 281 Midterm Cheat Sheet</a></li><li><a href="./cheatsheets/EECS-370-Midterm-Cheatsheet" data-for="cheatsheets/EECS-370-Midterm-Cheatsheet">EECS 370 Midterm Cheatsheet</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="classes"><button class="folder-button"><span class="folder-title">classes</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="classes"><li><a href="./classes/EECS-281" data-for="classes/EECS-281">Data Structures and Algorithms</a></li><li><a href="./classes/EECS-203" data-for="classes/EECS-203">Discrete Math</a></li><li><a href="./classes/EECS-376" data-for="classes/EECS-376">Foundations of Computer Science</a></li><li><a href="./classes/EECS-370" data-for="classes/EECS-370">Introduction to Computer Organization</a></li><li><a href="./classes/EECS-482" data-for="classes/EECS-482">Introduction to Operating Systems</a></li><li><a href="./classes/EECS-280" data-for="classes/EECS-280">Programming and Data Structures</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="exams"><button class="folder-button"><span class="folder-title">exams</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="exams"><li><a href="./exams/EECS-281-Midterm" data-for="exams/EECS-281-Midterm">EECS 281 Midterm</a></li><li><a href="./exams/EECS-370-Midterm" data-for="exams/EECS-370-Midterm">EECS 370 Midterm</a></li></ul></div></li><li><div class="folder-container"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="5 8 14 8" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="folder-icon"><polyline points="6 9 12 15 18 9"></polyline></svg><div data-folderpath="ia-applications"><button class="folder-button"><span class="folder-title">ia-applications</span></button></div></div><div class="folder-outer "><ul style="padding-left:1.4rem;" class="content" data-folderul="ia-applications"><li><a href="./ia-applications/EECS-203-IA-Application-Video-Plan" data-for="ia-applications/EECS-203-IA-Application-Video-Plan">EECS 203 IA Application Video Plan</a></li><li><a href="./ia-applications/EECS-281-IA-Application-Video-Plan" data-for="ia-applications/EECS-281-IA-Application-Video-Plan">EECS 281 IA Application Video Plan</a></li></ul></div></li><li><div class="folder-outer "><ul style="padding-left:0;" class="content" data-folderul></ul></div></li><li><a href="./Abstract-Data-Type-(ADT)" data-for="Abstract-Data-Type-(ADT)">Abstract Data Type (ADT)</a></li><li><a href="./Big-O-Notation" data-for="Big-O-Notation">Big-O Notation</a></li><li><a href="./Big-Omega" data-for="Big-Omega">Big-Omega</a></li><li><a href="./Caller-Save-vs-Callee-Save" data-for="Caller-Save-vs-Callee-Save">Caller Save vs Callee Save</a></li><li><a href="./Combinational-Logic" data-for="Combinational-Logic">Combinational Logic</a></li><li><a href="./Complexity-Analysis" data-for="Complexity-Analysis">Complexity Analysis</a></li><li><a href="./Deque" data-for="Deque">Deque</a></li><li><a href="./Finite-State-Machine-(FSM)" data-for="Finite-State-Machine-(FSM)">Finite State Machine (FSM)</a></li><li><a href="./Floating-Point-Numbers" data-for="Floating-Point-Numbers">Floating Point Numbers</a></li><li><a href="./Generating-Unique-Identifiers" data-for="Generating-Unique-Identifiers">Generating Unique Identifiers</a></li><li><a href="./Instruction-Set-Architecture-(ISA)" data-for="Instruction-Set-Architecture-(ISA)">Instruction Set Architecture (ISA)</a></li><li><a href="./LC2K" data-for="LC2K">LC2K</a></li><li><a href="./LC2K-Multi-Cycle-Datapath" data-for="LC2K-Multi-Cycle-Datapath">LC2K Multi-Cycle Datapath</a></li><li><a href="./LC2K-Single-Cycle-Datapath" data-for="LC2K-Single-Cycle-Datapath">LC2K Single-Cycle Datapath</a></li><li><a href="./LEGv8" data-for="LEGv8">LEGv8</a></li><li><a href="./Linking" data-for="Linking">Linking</a></li><li><a href="./Number-Bases" data-for="Number-Bases">Number Bases</a></li><li><a href="./Object-Files" data-for="Object-Files">Object Files</a></li><li><a href="./Pipelining" data-for="Pipelining">Pipelining</a></li><li><a href="./Priority-Queue" data-for="Priority-Queue">Priority Queue</a></li><li><a href="./Queue" data-for="Queue">Queue</a></li><li><a href="./Read-Only-Memory-(ROM)" data-for="Read-Only-Memory-(ROM)">Read Only Memory (ROM)</a></li><li><a href="./Registers" data-for="Registers">Registers</a></li><li><a href="./Sequential-Logic" data-for="Sequential-Logic">Sequential Logic</a></li><li><a href="./Stack" data-for="Stack">Stack</a></li><li><a href="./Trends-in-Computing" data-for="Trends-in-Computing">Trends in Computing</a></li><li><a href="./Two's-Complement-Numbers" data-for="Two's-Complement-Numbers">Two's Complement Numbers</a></li></ul></div></li><li id="explorer-end"></li></ul></div></div></div><div class="center"><div class="page-header"><div class="popover-hint"><nav class="breadcrumb-container" aria-label="breadcrumbs"><div class="breadcrumb-element"><a href="./">Home</a><p> ❯ </p></div><div class="breadcrumb-element"><a href>Pipelining</a></div></nav><h1 class="article-title">Pipelining</h1><p show-comma="true" class="content-meta"><span>Mar 01, 2024</span><span>8 min read</span></p><ul class="tags"><li><a href="./tags/eecs-370" class="internal tag-link">eecs-370</a></li></ul></div></div><article class="popover-hint"><p>Relevant Classes: <a href="./classes/EECS-370" class="internal alias" data-slug="classes/EECS-370">EECS 370</a></p>
<p>When considering a <a href="./LC2K-Single-Cycle-Datapath" class="internal alias" data-slug="LC2K-Single-Cycle-Datapath">Single-Cycle Processor</a>Multi-Cycle Processor]] has a higher <code>CPI</code>, but a lower clock period. With Pipelining, we hope to take the best of both worlds: approach a <code>CPI</code> of 1 while being able to keep a lower clock period.</p>
<p>You might notice that in a <a href="./LC2K-Multi-Cycle-Datapath" class="internal alias" data-slug="LC2K-Multi-Cycle-Datapath">Multi-Cycle Processor</a>, a lot of the hardware is being unused at a certain time: the idea behind pipelining is to use this unused hardware to start working on future instructions at the same time as current ones. This concept is referred to as <a href="./Parallelism" class="internal" data-slug="Parallelism">Parallelism</a>.</p>
<p>A great analogy to pipelining are Drive-Thrus…</p>
<h1 id="the-datapath">The Datapath<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#the-datapath" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p><img src="./assets/lc2k-pipelined-datapath.png" width="auto" height="auto" alt/></p>
<p>The biggest change is the introduction of pipeline registers: these preserve / store the previous values of a certain pipeline step to allow moving from one step to the next without having the next instruction modify data that is being used.</p>
<p>Other Minor Changes:</p>
<ul>
<li>Introducing More <a href="./Combinational-Logic#adders" class="internal alias" data-slug="Combinational-Logic">Adders</a>ALUs]] again (like in Single-Cycle) since they’ll be used at the same time</li>
<li>Reversing the von Neumann Architecture again (splitting up Data and Instruction Memory)
<ul>
<li>Note: this will be amended / explained later in the course to make this no longer an issue</li>
</ul>
</li>
</ul>
<h2 id="stage-1-fetch-if">Stage 1: Fetch (IF)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#stage-1-fetch-if" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ol>
<li>Fetch the next instruction and store it in the pipeline register</li>
<li>Calculate <code>PC + 1</code> and store it in <code>PC</code> (unless you get a different value from <code>beq</code> or <code>jalr</code>)
<ol>
<li>Also store <code>PC + 1</code> in pipeline register</li>
</ol>
</li>
</ol>
<h2 id="stage-2-decode-id">Stage 2: Decode (ID)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#stage-2-decode-id" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ol>
<li>Read Register Values and store it in the next pipeline register</li>
<li>Pass forward the instruction bits and <code>PC + 1</code> to the next pipeline register</li>
</ol>
<h2 id="stage-3-execute-ex">Stage 3: Execute (EX)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#stage-3-execute-ex" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<ol>
<li>Actually use ALU to do operation (<code>add</code>, <code>nor</code>, <code>regA + offset</code>, etc) and store it in the next pipeline register</li>
<li>Also calculate <code>PC + 1 + offset</code> in case it is needed and pass it to the next pipeline register</li>
<li>Pass forward the contents of <code>regB</code> and instruction bits to the next pipeline register</li>
</ol>
<h2 id="stage-4-memory-operation-mem">Stage 4: Memory Operation (Mem)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#stage-4-memory-operation-mem" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Note: this is only used in the case of <code>lw/sw</code></p>
<ol>
<li>Potentially use ALU Result as destination for value of <code>regB</code> in the case of <code>sw</code> and pass forward the memory data read (for the case of <code>lw</code>)</li>
<li>Pass forward ALU Result and instruction bits to the next pipeline register</li>
<li>At this stage, pass <code>PC + 1 + offset</code> back to the original Fetch Stage</li>
</ol>
<h2 id="stage-5-write-back-wb">Stage 5: Write Back (WB)<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#stage-5-write-back-wb" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>This is only used for things that need to be written back to register files (<code>lw</code>, <code>add/nor</code>).</p>
<ol>
<li>Based on the instruction, pass the relevant values back to the Decode Stage where the Register file is stored.</li>
<li>Also turn on / off the write enable signal</li>
</ol>
<h1 id="hazards">Hazards<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hazards" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h1>
<p>There are two main types of hazards: <strong>Data Hazards</strong> and <strong>Control Hazards</strong>.</p>
<p><strong>Data Hazards:</strong> Since register reads happen at Stage 2 and register writes happen at stage 5, it is possible to read an old / stale value before the correct value is written back in.</p>
<p><strong>Control Hazards:</strong> A branch instruction may change the PC, but not until stage 4. What do we fetch before that? (In modern processors, this is where <a href="./Branch-Prediction" class="internal alias" data-slug="Branch-Prediction">Branch Prediction</a> comes into play).</p>
<h2 id="data-hazards">Data Hazards<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#data-hazards" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>Some preliminary definitions:</p>
<p><strong>Data Dependency</strong>: one instruction uses the result of a previous one (not necessarily problematic)</p>
<p><strong>Data Hazard:</strong> one instruction has a data dependency that will cause a problem if we don’t properly handle it.</p>
<blockquote>
<p>We can assume that, if you’re reading from a register the same cycle you’re writing to it, the register file is smart enough to give the reader will give you the correct (new) value. This will help us identify data hazards. This is also consistent with most processors (ARM, x86) but not on the next EECS 370 Project.</p>
</blockquote>
<p>Example A:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="lc2k" data-theme="github-light github-dark"><code data-language="lc2k" data-theme="github-light github-dark" style="display:grid;"><span data-line><span>add 1 2 3</span></span>
<span data-line><span>nor 3 4 5</span></span></code></pre></figure>
<p>It is very clear here that the <code>nor</code> has a data dependency on <code>add</code>. However, in our pipeline processor, if we load <code>nor</code> beforehand, it will read the old value in <code>r3</code> before it is updated by the <code>add</code> instruction, leading to subsequent incorrect calculations.</p>
<p>There are three basic solutions to handling data hazards:</p>
<ul>
<li><strong>Avoid</strong>: Make sure there are no hazards in the code (rip programmer).</li>
<li><strong>Detect and Stall</strong>: If hazards exist, stall the processor until they go away.</li>
<li><strong>Detect and Forward</strong>: If hazards exist, fix the pipeline to get the correct value if possible (hardware changes)</li>
</ul>
<h3 id="avoidance">Avoidance<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#avoidance" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Simply: make sure there are no ha</p>
<p>”Solution” to Example A:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="lc2k" data-theme="github-light github-dark"><code data-language="lc2k" data-theme="github-light github-dark" style="display:grid;"><span data-line><span>add 1 2 3</span></span>
<span data-line><span>noop</span></span>
<span data-line><span>noop</span></span>
<span data-line><span>nor 3 4 5</span></span></code></pre></figure>
<p>Clearly, this isn’t that great. Since the <a href="./Instruction-Set-Architecture-(ISA)" class="internal alias" data-slug="Instruction-Set-Architecture-(ISA)">ISA</a> doesn’t describe the hardware, each iteration of a processor could have a different number of pipelines, so code will have to be recompiled each time. Furthermore, after compiling, a bunch of <code>noop</code> instructions would be introduced, adding to the executable size. And if that wasn’t enough, it also (clearly) makes the program slower.</p>
<h3 id="detect-and-stall">Detect and Stall<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#detect-and-stall" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Essentially, do the insertion of <code>noops</code> at the hardware level.</p>
<p>This makes sure code doesn’t need to change, but adds a small amount of hardware complexity. This solves the backwards compatibility and executable size issue, but does not fix the speed of the program: <code>CPI</code> is no longer approaching 1 because of all the stalling we’re doing.</p>
<h3 id="detect-and-forward">Detect and Forward<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#detect-and-forward" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>There are certain values of data that are ready at different stages of the program (e.g. <code>add/nor</code> results are ready after the execute stage). If we can skip the writeback stage during a hazard and forward those results early, we could avoid a lot of excess stalls. Essentially, allow the program to read incorrect values from the register first, and then modify / update them later before they’re used using hardware rerouting.</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="ad-warning" data-theme="github-light github-dark"><code data-language="ad-warning" data-theme="github-light github-dark" style="display:grid;"><span data-line><span>This does not eliminate all stalls, but can greatly reduce the number of stalls needed in a program compared with [[#detect-and-stall|Detect and Stall]].</span></span></code></pre></figure>
<p>This leads to four different types of hazards, which all require different approaches to solving the hazard. The following assembly should describe these different options:</p>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="lc2k" data-theme="github-light github-dark"><code data-language="lc2k" data-theme="github-light github-dark" style="display:grid;"><span data-line><span>add 1 2 3</span></span>
<span data-line><span>nor 2 3 4 ; hazard &quot;1&quot; </span></span>
<span data-line><span>add 6 3 7 ; hazard &quot;2&quot;</span></span>
<span data-line><span>lw 3 6 10 ; no hazard</span></span>
<span data-line><span>sw 6 2 12 ; hazard &quot;3&quot;</span></span></code></pre></figure>
<blockquote>
<p>These Hazards are not mutually exclusive: <code>regA</code> and <code>regB</code> can both be hazarded, and the hazards can be different. Therefore, the circuit gets quite a bit more complicated.</p>
</blockquote>
<figure data-rehype-pretty-code-figure><pre tabindex="0" data-language="ad-tldr" data-theme="github-light github-dark"><code data-language="ad-tldr" data-theme="github-light github-dark" style="display:grid;"><span data-line><span>The only time a stall is now added is when have an `lw` command directly followed by a dependent instruction (since `lw` requires an additional cycle to read from memory).</span></span></code></pre></figure>
<h4 id="hazard-1">Hazard “1”<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hazard-1" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>In this case, the value of register 3 should actually come from the result of the previous ALU operation. Therefore, we can use a <a href="./Combinational-Logic#muxes" class="internal alias" data-slug="Combinational-Logic">Mux</a> to decide between using the Register Value and the previous ALU calculation (based on the Hazard State)</p>
<h4 id="hazard-2">Hazard “2”<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hazard-2" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>In this case, we still depend on the value of register 3 which is now in the Memory Stage. We add another wire from the forwarded ALU result to the Mux described in <a href="#hazard-1" class="internal alias">Hazard “1”</a> and can use the flag of Hazard “2” to choose the correct value.</p>
<h4 id="hazard-3">Hazard “3”<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#hazard-3" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h4>
<p>This can’t be solved with forwarding: <code>lw</code> needs to finish accessing data memory before it knows what the new value for the register is supposed to be. In this case, we can <code>stall</code> once so that we can finish reading from memory.</p>
<p>We only need to stall once, however, because we can directly link the <a href="#stage-5-write-back-wb" class="internal alias">Writeback Stage</a>Execute Stage]] and use a Mux to decide between which value to use.</p>
<h2 id="control-hazards">Control Hazards<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#control-hazards" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h2>
<p>When we’re branching, the <a href="./Program-Counter" class="internal alias" data-slug="Program-Counter">Program Counter</a> can potentially change, so we don’t really know what the actual next instructions are going to be.</p>
<p>Just like with <a href="#data-hazards" class="internal alias">Data Hazards</a>, we have three strategies to handle control hazards.</p>
<ol>
<li><strong>Avoid</strong>: Don’t include <code>beq</code> in code</li>
<li><strong>Detect and Stall</strong></li>
<li><strong>Speculate and Squash-If-Wrong</strong>:
<ul>
<li>Guess outcomes of branch</li>
<li>Fetch instructions assuming we’re right</li>
<li>Stop them if they shouldn’t have been executed (this relies on the <a href="#stage-5-write-back-wb" class="internal alias">Writeback</a> stage stopping any data modification until the end)</li>
<li>“<a href="./Branch-Prediction" class="internal alias" data-slug="Branch-Prediction">Branch Prediction</a>” when complex</li>
</ul>
</li>
</ol>
<p>Because Avoid is very self explanatory and similar to what we explained <a href="#data-hazards" class="internal alias">Data Hazards</a>, I won’t add this here.</p>
<h3 id="detect-and-stall-1">Detect and Stall<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#detect-and-stall-1" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Detection:</p>
<ul>
<li>wait until decode</li>
<li>check if <code>opcode == beq or jalr</code></li>
</ul>
<p>Stall:</p>
<ul>
<li>Keep current instructions in fetch</li>
<li>Insert <code>noops</code></li>
<li>Pass <code>noop</code> to decode stage, not execute (pass early)</li>
</ul>
<p>For each <code>beq</code>, this inserts 3 <code>noop</code> instructions.</p>
<h3 id="speculate-and-squash-if-wrong">Speculate and Squash-If-Wrong<a role="anchor" aria-hidden="true" tabindex="-1" data-no-popover="true" href="#speculate-and-squash-if-wrong" class="internal"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a></h3>
<p>Speculate: assume they’re not equal</p>
<ul>
<li>Keep fetching from <code>PC + 1</code> until we know that the branch is really taken</li>
</ul>
<p>Squash: stop bad instructions if taken</p>
<ul>
<li>send a <code>noop</code> to Decode, Execute, and Memory
<ul>
<li>overwriting any instruction that might have been there and essentially turning all calculated values into junk</li>
<li>only adds the 3 <code>noop</code> instructions in “half” the cases</li>
</ul>
</li>
<li>send target address to <code>PC</code></li>
</ul></article></div><div class="right sidebar"><div class="graph"><h3>Graph View</h3><div class="graph-outer"><div id="graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:1,&quot;scale&quot;:1.1,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:false}"></div><svg version="1.1" id="global-graph-icon" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 55 55" fill="currentColor" xml:space="preserve"><path d="M49,0c-3.309,0-6,2.691-6,6c0,1.035,0.263,2.009,0.726,2.86l-9.829,9.829C32.542,17.634,30.846,17,29,17
	s-3.542,0.634-4.898,1.688l-7.669-7.669C16.785,10.424,17,9.74,17,9c0-2.206-1.794-4-4-4S9,6.794,9,9s1.794,4,4,4
	c0.74,0,1.424-0.215,2.019-0.567l7.669,7.669C21.634,21.458,21,23.154,21,25s0.634,3.542,1.688,4.897L10.024,42.562
	C8.958,41.595,7.549,41,6,41c-3.309,0-6,2.691-6,6s2.691,6,6,6s6-2.691,6-6c0-1.035-0.263-2.009-0.726-2.86l12.829-12.829
	c1.106,0.86,2.44,1.436,3.898,1.619v10.16c-2.833,0.478-5,2.942-5,5.91c0,3.309,2.691,6,6,6s6-2.691,6-6c0-2.967-2.167-5.431-5-5.91
	v-10.16c1.458-0.183,2.792-0.759,3.898-1.619l7.669,7.669C41.215,39.576,41,40.26,41,41c0,2.206,1.794,4,4,4s4-1.794,4-4
	s-1.794-4-4-4c-0.74,0-1.424,0.215-2.019,0.567l-7.669-7.669C36.366,28.542,37,26.846,37,25s-0.634-3.542-1.688-4.897l9.665-9.665
	C46.042,11.405,47.451,12,49,12c3.309,0,6-2.691,6-6S52.309,0,49,0z M11,9c0-1.103,0.897-2,2-2s2,0.897,2,2s-0.897,2-2,2
	S11,10.103,11,9z M6,51c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S8.206,51,6,51z M33,49c0,2.206-1.794,4-4,4s-4-1.794-4-4
	s1.794-4,4-4S33,46.794,33,49z M29,31c-3.309,0-6-2.691-6-6s2.691-6,6-6s6,2.691,6,6S32.309,31,29,31z M47,41c0,1.103-0.897,2-2,2
	s-2-0.897-2-2s0.897-2,2-2S47,39.897,47,41z M49,10c-2.206,0-4-1.794-4-4s1.794-4,4-4s4,1.794,4,4S51.206,10,49,10z"></path></svg></div><div id="global-graph-outer"><div id="global-graph-container" data-cfg="{&quot;drag&quot;:true,&quot;zoom&quot;:true,&quot;depth&quot;:-1,&quot;scale&quot;:0.9,&quot;repelForce&quot;:0.5,&quot;centerForce&quot;:0.3,&quot;linkDistance&quot;:30,&quot;fontSize&quot;:0.6,&quot;opacityScale&quot;:1,&quot;showTags&quot;:true,&quot;removeTags&quot;:[],&quot;focusOnHover&quot;:true}"></div></div></div><div class="toc desktop-only"><button type="button" id="toc" class><h3>Table of Contents</h3><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="fold"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div id="toc-content"><ul class="overflow"><li class="depth-0"><a href="#the-datapath" data-for="the-datapath">The Datapath</a></li><li class="depth-1"><a href="#stage-1-fetch-if" data-for="stage-1-fetch-if">Stage 1: Fetch (IF)</a></li><li class="depth-1"><a href="#stage-2-decode-id" data-for="stage-2-decode-id">Stage 2: Decode (ID)</a></li><li class="depth-1"><a href="#stage-3-execute-ex" data-for="stage-3-execute-ex">Stage 3: Execute (EX)</a></li><li class="depth-1"><a href="#stage-4-memory-operation-mem" data-for="stage-4-memory-operation-mem">Stage 4: Memory Operation (Mem)</a></li><li class="depth-1"><a href="#stage-5-write-back-wb" data-for="stage-5-write-back-wb">Stage 5: Write Back (WB)</a></li><li class="depth-0"><a href="#hazards" data-for="hazards">Hazards</a></li><li class="depth-1"><a href="#data-hazards" data-for="data-hazards">Data Hazards</a></li><li class="depth-2"><a href="#avoidance" data-for="avoidance">Avoidance</a></li><li class="depth-2"><a href="#detect-and-stall" data-for="detect-and-stall">Detect and Stall</a></li><li class="depth-2"><a href="#detect-and-forward" data-for="detect-and-forward">Detect and Forward</a></li><li class="depth-1"><a href="#control-hazards" data-for="control-hazards">Control Hazards</a></li><li class="depth-2"><a href="#detect-and-stall-1" data-for="detect-and-stall-1">Detect and Stall</a></li><li class="depth-2"><a href="#speculate-and-squash-if-wrong" data-for="speculate-and-squash-if-wrong">Speculate and Squash-If-Wrong</a></li></ul></div></div><div class="backlinks"><h3>Backlinks</h3><ul class="overflow"><li><a href="./cheatsheets/EECS-370-Midterm-Cheatsheet" class="internal">EECS 370 Midterm Cheatsheet</a></li><li><a href="./exams/EECS-370-Midterm" class="internal">EECS 370 Midterm</a></li></ul></div></div></div><footer class><hr/><p>Created with <a href="https://quartz.jzhao.xyz/">Quartz v0.0.1</a> © 2024</p><ul><li><a href="https://github.com/bansalsh-umich/course-notes">GitHub</a></li></ul></footer></div></body><script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/copy-tex.min.js" type="application/javascript"></script><script type="application/javascript">function c(){let t=this.parentElement;t.classList.toggle("is-collapsed");let l=t.classList.contains("is-collapsed")?this.scrollHeight:t.scrollHeight;t.style.maxHeight=l+"px";let o=t,e=t.parentElement;for(;e;){if(!e.classList.contains("callout"))return;let n=e.classList.contains("is-collapsed")?e.scrollHeight:e.scrollHeight+o.scrollHeight;e.style.maxHeight=n+"px",o=e,e=e.parentElement}}function i(){let t=document.getElementsByClassName("callout is-collapsible");for(let s of t){let l=s.firstElementChild;if(l){l.addEventListener("click",c),window.addCleanup(()=>l.removeEventListener("click",c));let e=s.classList.contains("is-collapsed")?l.scrollHeight:s.scrollHeight;s.style.maxHeight=e+"px"}}}document.addEventListener("nav",i);window.addEventListener("resize",i);
</script><script type="module">
          let mermaidImport = undefined
          document.addEventListener('nav', async () => {
            if (document.querySelector("code.mermaid")) {
              mermaidImport ||= await import('https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs')
              const mermaid = mermaidImport.default
              const darkMode = document.documentElement.getAttribute('saved-theme') === 'dark'
              mermaid.initialize({
                startOnLoad: false,
                securityLevel: 'loose',
                theme: darkMode ? 'dark' : 'default'
              })

              await mermaid.run({
                querySelector: '.mermaid'
              })
            }
          });
          </script><script type="application/javascript">
            const socket = new WebSocket('ws://localhost:3001')
            // reload(true) ensures resources like images and scripts are fetched again in firefox
            socket.addEventListener('message', () => document.location.reload(true))
          </script><script src="./postscript.js" type="module"></script></html>